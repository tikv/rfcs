# TiKV `API V2`

## Motivation

`API V2` is a set of breaking changes that aims to solve serval issues with current RawKV (hereafter referred to as `API V1`):

1. `API V1` is not safe to use RawKV along with TxnKV.
2. `API V1` Raw TTL is controlled by Store configuration. Switching the configuation will cause data corruption in silence.
3. `API V1` Raw TTL is encoded into the value by appending 8-bytes UNIX timastamp to the end of the value, therefor it's hard to introduce other encode afterwards.

By solving the issue 1, TiDB will be able to support RawKV as the table's storage engine, which will enrich TiDB's use cases.

## Document-level design

This RFC introduces a new key encode to RawKV and TxnKV, and a new value encode to RawKV, which will allow the RawKV to be used along with TxnKV and also allow tikv to flexibly add meta, e.g. the TTL, to a RawKV value.

The `API V2` is enabled by a switch on PD. Since it changes the storage encode, it will be not compatible to switch between `API V1` and `API V2` while there are non-TiDB data in TiKV. TiDB data is specially treated in order to not affected by the change.

### Upgrade

Upgrade from `API V1` to `API V2` is a simple process:

1. Update TiKV, TiDB and PD to the version that supports `API V2`.
2. Ensure that no non-TiDB data in TiKV. Detele if any. (Guarrenteed by user)
3. Ensure that no non-TiDB client is online. (Guarrenteed by user)
4. Use `pd-ctl` to enable `API V2`.
5. Restart all TiKV. (Guarrenteed by user)

### Downgrade

Downgrade from `API V2` to `API V1` is also simple:

1. Ensure that no non-TiDB TiKV client is online.
2. Ensure that no non-TiDB data in TiKV. Detele if any. (Guarrenteed by user)
3. Use `pd-ctl` to disable `API V2`.
4. Restart all TiKV. (Guarrenteed by user)

### Client

TiKV clients will have a new configuatrion choosing `API V1` or `API V2` mode on connecting to TiKV.

TiKV will reject the request if the client mode mismatched to the TiKV configuration. There is one exception: With TiKV in `API V2` mode, you can use `TxnClient` in `API V1` mode to access the TiDB data (key start with `m` or `t`) which is invisible to the client in `API V2` mode.

Note that in `API V2` mode, you can't specify CF in `RawClient`.

Using TxnKV along with RawKV is safe in `API V2` mode.

## Reference-level design

### RawKV Key Encode

Once the `API V2` is enabled, the key will be either start with either:

1. `m` or `t`: TxnKV key. Used by TiDB.
2. `x\0`: TxnKV key. The `\0` is a placeholder for the potential [Keyspace](https://github.com/tikv/rfcs/pull/39).
3. `r\0`: RawKV key.

Note that in TxnKV, the key will be encoded by `Memory Comparable Encoding`. But since the `Memory Comparable Encoding` will not change the starting bytes but only add paddings, there won't be any overlap between RawKV and TxnKV.

### RawKV Value Encode

If the key is started with `r`, then the value can be either:

1. `{0x0}{data}`
2. `{0x1}{TTL expire timestamp}{data}`

### PD

Add a new configuatrion `enable_api_v2` which can be configured by `pd-ctl`. When switching on or off, PD will sychronize the configuration to all TiKVs. PD should scan keys to check that no non-TiDB data exists while swiching `enable_api_v2`.

### TiKV

Add a new configuatrion `storage.enable_api_v2`. When enabled, `storage.enable_ttl` must also be enabled. TiKV will carry it's `storage.enable_api_v2` in `PutStore` request. PD will reject the `PutStore` if the switch mismatched.

Add `enable_api_v2` to `SSTMeta` and reject importing SST file if the switch mismatched.

Add a field `enable_api_v2` to TiKV gRPC's context.

If `stoarge.enable_api_v2` is set:

- If the request's context has `enable_api_v2=false`, reject the request except for it's a TxnKV request and the keys start with `m` or `t`.

- If the request's context has `enable_api_v2=true`, only allow the key to start with `r\0` on RawKV API and only allow the key to start with `t\0` on TxnKV API.

- Run TTL compaction filter only on the keys starting with `r`.

- Use the `API V2` Value encode in `RawStore`, `TTLStore` and `sst_importer`.

If `stoarge.enable_api_v2` is not set:

- Reject all request with `enable_api_v2` in the context.

### TiKV Clients

Provide two modes for user:

- V2: Prepend `t\0` on TxnKV keys and prepend `r\0` on RawKV keys. Set `enable_api_v2` to `true` on TiKV gRPC's `Context`.
- V1: Behave as present client. Set `enable_api_v2` to `false` on TiKV gRPC's `Context`.

### TiDB

Upgrade to the lastest TiKV Go Client and use `V1` mode.

## Unresolved questions

1. Should we change the `enable_api_v2` to a int field `api_version`?
