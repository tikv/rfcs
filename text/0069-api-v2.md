# TiKV API V2

## Motivation

`API V2` is a set of breaking changes that aim to solve serval issues with current RawKV (hereafter referred to as `API V1`):

1. RawKV is not safe to use along with TxnKV. By solving this, TiDB will be able to support RawKV as the table's storage engine, which will enrich TiDB's use cases.
2. RawKV TTL is controlled by Store configuration. Switching the configuration will cause data corruption in silence.
3. RawKV TTL is encoded into the value by appending 8-bytes UNIX timestamp to the end of the value, therefore it's hard to introduce other encode afterward.
4. RawKV compare_and_swap is easy to make mistake.
5. It could be nice if we can deploy multiple applications on one TiKV cluster.

## Document-level design

This RFC introduces a new key encode to RawKV and TxnKV, and a new value encode to RawKV, which will allow the RawKV to be used along with TxnKV and also allow TiKV to flexibly add meta, e.g. the TTL, to a RawKV value.

In addition, keys will be contained in keyspaces, where the keys in different keyspace are totally independant. If keyspace is not specified, the keyspace 'default' will be used.

The `API V2` is enabled by a switch on PD. Since it changes the storage encode, it will be not compatible to switch between `API V1` and `API V2` while there are non-TiDB data in TiKV. TiDB data is specially treated in order to not be affected by the change.

### Upgrade

Upgrade from `API V1` to `API V2` is a simple process:

1. Update TiKV, TiDB, and PD to the version that supports `API V2`.
2. Ensure that no non-TiDB data is in TiKV. Detele if any.
3. Ensure that no non-TiDB client is online.
4. Use `pd-ctl` to enable `API V2`.
5. Enable `API V2` in TiKV config file and restart TiKV.

### Downgrade

Downgrade from `API V2` to `API V1` is also simple:

1. Ensure that no non-TiDB TiKV client is online.
2. Ensure that no non-TiDB data is in TiKV. Detele if any.
3. Use `pd-ctl` to disable `API V2`.
4. Disable `API V2` in TiKV config file and restart TiKV.

### CDC / BR

Since all access to TiDB is unchanged during the upgrade, CDC and BR should work trivally on TiDB data.

### Data migration

It's reasonable to provide a way to import and export non-TiDB data in TiKV during the upgrade or downgrade. On TiKV before 4.0, the only way to do that is `scan` and `batch_put` on the client. After 4.0, TiKV start to support importing SST file into TxnKV, and after 5.1, importing on RawKV is also supported. You can find more information in [`RFC: Online Bulk Load for RawKV`](https://github.com/tikv/rfcs/pull/72).

### Client Version

TiKV clients will have a new configuration choosing `API V1` or `API V2` mode on connecting to TiKV.

TiKV will reject the request if the client mode is mismatched to the TiKV configuration. There is one exception: With TiKV in `API V2` mode, you can use `TxnClient` in `API V1` mode to access the TiDB data (key starting with `m` or `t`) which is invisible to the client in `API V2` mode.

Note that in `API V2` mode, you can't specify CF in `RawClient`.

Using TxnKV along with RawKV is safe in `API V2` mode.

Listed below is the detailed compatibility matrix:

|              | V1 Server | V2 Server |
| ------------ | --------- | --------- |
| V1 RawClient | Raw Data  | Forbidden |
| V1 TxnClient | Txn Data  | TiDB Data |
| V2 RawClient | Forbidden | Raw Data  |
| V2 TxnClient | Forbidden | Txn Data  |

### Keyspace

When API V2 is enabled for the client, the user will be able to specify a keyspace for a session of `RawClient` or `TxnCient`. A keyspace is identified by a string, whose default value is 'default'.

Keys in other keyspace will be invisible to the user.

## Reference-level design

### Key Encode

Once the `API V2` is enabled, the key will be starting with either:

1. `m` or `t`: TxnKV key. Used by TiDB.
2. `x{keyspace prefix id}`: TxnKV key.
3. `r{keyspace prefix id}`: RawKV key.
4. `a{keyspace prefix id}`: RawKV atomic key, on which you can use `CompareAndSwap`.

The `{keyspace prefix id}` is the [keyspace](https://github.com/tikv/rfcs/pull/39) prefix for seperating keys of different keyspace. It should be an vary-length integer whose highest bit of every byte denotes whether the next byte is still part of the integer. The client will fetch the prefix from PD by the keyspace name specified by the user when initializing the client, so it means that the keyspace prefix is valid during the session, in other words, the change on keyspace on PD will not take effect on running seesions.

Note that in TxnKV, the key will be encoded by `Memory Comparable Encoding`. But since the `Memory Comparable Encoding` will not change the starting bytes and only add paddings, there won't be any overlap between RawKV and TxnKV.

### RawKV Value Encode

If the key is started with `r` or `a`, then the value can be either:

1. `{0x0}{data}`
2. `{0x1}{TTL expire timestamp}{data}`

### PD

Add a new http interface for adding, renaming, deleteing and querying the mapping from keyspace name to prefix id:

```javascript
// list all keyspaces
GET /keyspaces
[
  {
    name: "default",
    id: "0"
  },
  {
    name: "redis",
    id: "1"
  }
]

// add new keyspace
POST /keyspaces
{
  name: "mongodb",
  // optional, pd will allocate one if not specified
  id: "2"
}

// delete a keyspace
DELETE /keyspaces/{keyspace_name}
```

The keyspace is stored in etcd and should have no limitation on the numbers.

### TiKV

In TiKV config file, add a new configuration `storage.api_version`. When enabled, `storage.enable_ttl` must also be enabled.

In kvdb, add a store meta `api_version`. When the store meta mismatches the config `storage.enable_ttl`, it means that the user is switching the API version, then check no non-TiDB exist, and then save the new api version in store meta.

In kvproto message `SSTMeta`, add `api_version`. Reject the SST file if the version is mismatched.

In TiKV gRPC's context, add a field `api_version`.

If `storage.api_version=2`:

- Run TTL compaction filter only on the keys starting with `r`.

- Use the `API V2` Value encode in `RawStore`, `TTLStore` and `sst_importer`.

- If the request's context has `api_version=1`:
  - Reject the request unless it's a TxnKV request and the keys starting with `m` or `t`.

- If the request's context has `api_version=2`:
  - Only allow the key to start with `r\0` or `a\0` on RawKV API
  - Only allow the key to start with `t\0` on TxnKV API.
  - Only allow `RawCompareAndSwap` on key staring with `a`.
  - Deprecate `for_cas` in `RawPut` and `RawDelete` request.

If `storage.api_version=1`:

- Reject all requests with `api_version=2` in the context.

### tikv-ctl

Read `api_version` in kvdb and decode data using the corresponding version.

### TiKV Clients

Provide two modes for users:

- V2: Fetch keyspace prefix by keyspace name from PD and then prepend `t{keyspace prefix}` on TxnKV keys or prepend `r{keyspace prefix}` on RawKV keys. Set `api_version=2` in TiKV gRPC's `Context`.
- V1: Behave as present client. Set `api_version=1` in TiKV gRPC's `Context`.

### TiDB

Upgrade to the latest TiKV Go Client and use `V1` mode.

## Unresolved questions
